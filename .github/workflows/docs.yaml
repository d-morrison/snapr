# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
# Deploys altdoc for Pull Requests, tags, and pushes to main branch
# PRs are deployed to /preview/pr<number>/
# Tags are deployed to /<tag>/
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    # uncomment the following lines to restrict when this workflow runs:
    # paths:
    #   - 'man/**'
    #   - 'altdoc/**'
    #   - 'vignettes/**'
    #   - '_quarto.yml'
    #   - '.github/workflows/docs.yaml'
    #   - 'README.md'
    #   - 'index.qmd'
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'         # build on version tags
      - '!v[0-9]+.[0-9]+.[0-9]+.[0-9]+' # but not if version involves a dev component
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to deploy
        required: false
        default: ''

name: docs

env:
    PREVIEW_BRANCH: gh-pages

jobs:
  docs:
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'pull_request' && github.event.action == 'closed') }}
    timeout-minutes: 30
    # Only restrict concurrency for non-PR jobs
    concurrency:
      group: docs-${{ github.event_name != 'pull_request' || github.run_id }}
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          tinytex: true

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: |
            connect
            website
          extra-packages: |
            d-morrison/altdoc@recursive-qmd-search
            quarto-dev/quarto
            any::sessioninfo
            local::.

      # Verify development environment is properly configured
      - name: Verify development environment
        shell: bash
        run: |
          echo "=== Development Environment Status ==="
          export QUARTO_LOG_LEVEL=DEBUG
          # Check R installation
          Rscript -e 'cat("R version:", R.version.string, "\n")'

          # Verify Quarto is installed and working
          echo ""
          echo "=== Quarto Status ==="
          quarto --version
          quarto check

          echo ""
          echo "Development environment setup complete!"

      - name: Build site
        # uncomment the next two lines to get full debugging output
        # env:
          # QUARTO_LOG_LEVEL: DEBUG
        timeout-minutes: 20
        run: |
          # If parallel = TRUE in render_docs()
          # future::plan(future::multicore)
          # sessioninfo::session_info() # already done in Install R dependencies
          altdoc::render_docs(verbose = TRUE, parallel = FALSE, freeze = FALSE)
        shell: Rscript {0}

      # If event is a tag, set subdir to '<tag_name>'
      - name: "[tag] Set documentation subdirectory"
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "subdir=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      # If event is workflow_dispatch, set subdir to 'inputs.tag'
      - name: '[dispatch] Set documentation subdirectory'
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "subdir=${{ github.event.inputs.tag }}" >> $GITHUB_ENV

      # If event is a push to main (not a tag), set subdir to empty (deploy to root)
      - name: "[main] Set documentation subdirectory to root"
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "PKGDOWN_DEV_MODE=release" >> $GITHUB_ENV
          echo "subdir=docs" >> $GITHUB_ENV

      - name: Debug subdir
        run: |
          echo "Subdir is set to: ${{ env.subdir }}"

      - name: Deploy to GitHub pages ðŸš€
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          clean-exclude: pr-preview
          branch: gh-pages # potentially different from ${{ env.PREVIEW_BRANCH }}
          folder: docs
          # target-folder: $subdir # figure out later

      - name: Deploy PR Preview
        id: preview-step
        if: github.event_name == 'pull_request'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: docs
          preview-branch: ${{ env.PREVIEW_BRANCH }}
          comment: "false"
          wait-for-pages-deployment: true

      # following https://github.com/rossjrw/pr-preview-action?tab=readme-ov-file#customise-the-sticky-comment:
      - uses: marocchino/sticky-pull-request-comment@v2
        if: steps.preview-step.outputs.deployment-action == 'deploy' && env.deployment_status == 'success'
        with:
          header: pr-preview
          recreate: true
          message: |
              [PR Preview Action](https://github.com/rossjrw/pr-preview-action) ${{ steps.preview-step.outputs.action-version }}
              :---:
              | <p><img src="https://qr.rossjrw.com/?url=${{ steps.preview-step.outputs.preview-url }}" height="100" align="right" alt="QR code for preview link"></p> :rocket: View preview at <br> ${{ steps.preview-step.outputs.preview-url }} <br><br>
              | <h6>Built to branch [`${{ env.PREVIEW_BRANCH }}`](${{ github.server_url }}/${{ github.repository }}/tree/${{ env.PREVIEW_BRANCH }}) at ${{ steps.preview-step.outputs.action-start-time }}. <br> Preview will be ready when the [GitHub Pages deployment](${{ github.server_url }}/${{ github.repository }}/deployments) is complete. <br><br> </h6>

      - uses: marocchino/sticky-pull-request-comment@v2
        if: steps.preview-step.outputs.deployment-action == 'remove' && env.deployment_status == 'success'
        with:
            header: pr-preview
            message: |
                [PR Preview Action](https://github.com/rossjrw/pr-preview-action) ${{ steps.preview-step.outputs.action-version }}
                :---:
                Preview removed because the pull request was closed.
                ${{ steps.preview-step.outputs.action-start-time }}

